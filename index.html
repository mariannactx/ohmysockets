<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ohmysockets!</title>
    <link rel="stylesheet" href="css/journal.css"/>
    <link rel="stylesheet" href="css/style.css"/>
    <script src="js/jquery.js"></script>
    <script src="js/util.js"></script>
    <script src="js/collapse.js"></script>
</head>
<body class="row">
    <header class="col-lg-2 bg-info">
        <nav class="navbar navbar-dark navbar-expand-lg">
            <a class="nav-link text-light text-center" href="#o-framework">
                <img id="logo" src="img/omskts.png"/>
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menu-toggler">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="menu-toggler">
            <ul class="navbar-nav mr-auto flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="#documentacao">
                        - <br/>Documentação
                    </a>
                    <ul>
                        <li class="nav-item">
                            <a class="nav-link" href="#instalacao">
                                . Requisitos
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#instalacao">
                                . Downloads
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#inicializacao">
                                . Inicialização
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#como-funciona">
                                . O básico
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#exemplos">
                                - <br/>Exemplos</a>
                        </li>
                    </ul>
                </li>
            </ul>
            </div>
        </nav>
    </header>
    <main class="col-lg-10">
        <section id="o-framework">
            <h1 class="display-4">ohmysockets!</h1>
            <small class="text-muted">Abreviação para "oh my god, it's so simple to use websockets!".</small>
            <p class="lead">
                É um micro framework PHP simples e rápido para comunicação dentro de redes locais. Permite criar uma conexão persistente e bidirecional para ser utilizada em sua aplicação web sem complicações.
            </p>
            <hr class="my-4">
            <h3>Web, persistente e bidirecional</h3>
            <p> <i>Websockets</i> é o recurso que tornou possível usar o <i>browser</i> para abrir uma conexão que se mantém <i>sempre aberta e disponível</i> através da qual podemos enviar e receber informações <i>simultaneamente e sem interrupções</i>.</p>
            <h3>Módulos</h3>

            <h5>Servidor</h5>
            <p>Cria e mantém nossa conexão além de gerenciar os usuários que se conectarem ao nosso servidor. Inicializado com um quase nada de comandos no terminal.</p>
            <h5>Cliente</h5>
            <p>Apresenta <b>dois exemplos</b> simples e reutilizáveis para quem quer saber a opinião de sua audiência em tempo real ou competir com os amigos num jogo de plataforma.</p>

        </section>

        <section id="documentacao">
            <h1 class="display-4">Documentação</h1>
            <hr class="my-4">

            <article id="instalacao">
                <div class="card border-light">
                    <h2 class="card-header text-info">Requisitos</h2>
                    <div class="card-body">
                        <ul>
                            <li>Sistema operacional <a href="https://www.ubuntu.com/download/desktop">Ubuntu</a></li>
                            <li>Apache e PHP 7 <small> (siga o tutorial sobre <a href="https://www.digitalocean.com/community/tutorials/como-instalar-a-pilha-linux-apache-mysql-php-lamp-no-ubuntu-16-04-pt">como instalar um servidor web</a>)
                            </small>
                            </li>
                            <li> Rede local que permita acesso pelo IP </p>

                        </ul>
                    </div>
                </div>
            </article>

            <article id="instalacao">
                <div class="card border-light">
                    <h2 class="card-header text-info">Downloads</h2>
                    <div class="card-body">
                        <a class="btn btn-outline-danger" href="server.zip">
                            Módulo servidor
                        </a>
                        <a class="btn btn-outline-danger" href="ohmysockets.zip">
                            Módulos servidor e cliente
                        </a>
                    </div>
                </div>
            </article>

            <article id="inicializacao">
                <div class="card border-light">
                    <h2 class="card-header text-info">Inicialização</h2>
                    <div class="card-body">
                        <p> Primeiro, é necessário descobrir seu IP dentro da rede. Existem várias formas para isso, uma delas
                            é usar o comando <kbd style="white-space: nowrap">ifconfig | grep inet</kbd> no terminal. O resultado será 
                            algo do tipo: 
                            <pre>inet 192.168.0.18  netmask 255.255.255.0  broadcast 192.168.0.255</pre>
                            No exemplo acima, <i>192.168.9.18</i> é o seu ip.
                            <p> Depois, escolhemos a porta. Ela pode ser um número aleatório de 5 dígitos. Usaremos a porta <i>47401</i>.
                            Para que a conexão funcione, essa porta não pode estar ocupada e precisar estar liberada pelo firewall, caso esteja ativado.
                            Verificaremos a disponibilidade da porta com o seguinte comando: <kbd>sudo netstat -ptln | grep 47401 </kbd>. Se não aparecer 
                            nenhum resultado, tudo certo! A porta está disponível.</p>
                            <p> Para terminar a configuração, basta alterar os arquivos <i>common.js</i> e o <i>run.php</i> com o IP e a porta nos locais indicados. Tá tudo explicado na seção abaixo!</p>
                            <p> Com o servidor confirgurado, é hora de executar a conexão! Vá para o terminal, encontre o diretório onde está a aplicação e execute o comando
                            <kbd>php server/run.php</kbd>. Você verá algo como isto:</p>
                            <pre>
Server started
Listening on: 192.168.0.18:47401
Master socket: Resource id #7
                            </pre>
                            <p><span class="badge badge-pill badge-danger">Atenção!</span> Não feche o terminal! Fechá-lo vai encerrar a conexão.</p>
                            <p>Entenda um pouco mais do funcionamento da aplicação antes de partir para os exemplos na próxima seção.</p>
                    </div>
                </div>
            </article>

            <article id="como-funciona">
                <div class="card border-light">
                    <h2 class="card-header text-info">O básico</h2>
                    <div class="card-body">
                        <h4>A extensão sockets do PHP</h4>
                        <small><a href="https://secure.php.net/manual/pt_BR/book.sockets.php">manual oficial da extensão</a></small>
                        <p>O construtor da nossa classe abstrata WebsocketServer é o responsável por criar a conexão. Mais especificamente, <i>cria</i>, <i>configura</i>, <i>torna acessível</i> e <i>ouve</i> um <i>resource do tipo socket</i>.</p>

                        <pre>

$this->master = socket_create(...);

socket_set_option($this->master, ...);
socket_bind($this->master, <b>$addr</b>, <b>$port</b>);
socket_listen($this->master, 10);

$this->sockets['m'] = $this->master;
                        </pre>

                        <p>Onde <kbd>$addr</kbd> é o IP da máquina onde o servidor está e <kbd>$port</kbd> é uma porta disponível no nosso servidor - que pode ser aleatória. Essas informações são fornecidas no script run.php que vai ser executado via terminal (ou da maneira que você preferir):
                        </p>

                        <pre>

$server = new Server("192.168.0.0", '11111');
$server->run();
                        </pre>

                        <p>Se aparecer uma mensagem que começa com <b><i>"Server started"</i></b> deu tudo certo! O servidor está ouvindo requisições através da porta que você escolheu.</p>

                        <h4>A API Websockets</h4>
                        <small><a href="https://html.spec.whatwg.org/multipage/web-sockets.html">especificação oficial da API</a></small>
                        <p> Uma vez iniciada a conexão, nossa aplicação poderá enviar e receber dados através dela, utilizando a <i>API Websockets</i> e seus eventos com <i>javascript</i>.</p>
                        <pre>

socket = new WebSocket("ws://192.168.0.0:11111");

socket.onopen    = function(ev) {};
socket.onclose   = function(ev) {};
socket.onmessage = function(ev) {
    msg = JSON.parse(ev.data);
};

socket.send('{"prop":"value"}'); //string em formato JSON
                        </pre>
                        <p>É realmente muito simples: <kbd>onopen</kbd> acontece assim que a conexão é estabelecida, <kbd>onmessage</kbd> é disparada sempre que chegar novos dados e <kbd>onclose</kbd> quando a conexão for fechada pelo cliente ou pelo servidor.
                        </p>
                        <p><span class="badge badge-pill badge-danger">Atenção!</span> O evento <kbd>onmessage</kbd> traz um objeto do tipo MessageEvent, diferente das demais. A propriedade <kbd>data</kbd> contém os dados recebidos em uma string no formato JSON. Como implementação do framework, sempre possui a propriedade <kdb>user</kdb> como identificação do usuário que enviou a mensagem, até mesmo quando é o servidor. É utilizado <i>um número único com a função do PHP <kbd>uniqid()</kbd> </i> para identificar a origem da mensagem. Você pode modificar isso sobrescrevendo o método <kdb>setId()</kdb> da classe <kdb>User</kdb>, para utilizar um número incremental do seu banco de dados, por exemplo.
                        </p>

                        <h4>O protocolo websockets</h4>
                        <p style="display: inline-block; float:left; width: 50%; padding: 10px">
                        Perceba que a url utilizada na API não começa com o habitual <kbd>http://</kbd>, 
                        mas com <kbd>ws://</kbd>. Na aba <i>Network</i>, onde podem ser vistas as requisições
                        feitas pela página, podemos filtrar apenas as que são <i>websockets</i> (uma mesma aplicação pode manter
                        várias dessas conexões abertas). Nas aplicações de exemplo, abrirá apenas uma.
                        Com essa ferramenta é possível ver os cabeçalhos da requisição e acompanhar os dados que transitam por ela.
                        O vídeo ao lado é uma rápida demonstração do exemplo das carinhas - descrito melhor na próxima seção.
                        </p>
                        <video width="50%" style="float:right; display: inline;" src="vid/websockets-network.mp4" controls></video>
                   
                        
                    </div>
                </div>
            </article>


            <article id="exemplos">
                <div class="card border-light">
                    <h2 class="card-header text-info">Exemplos</h2>
                    <div class="card-body">
                        <p class="lead">
                            De modo geral, os exemplos possuem dois tipos de aplicações: a <i>aplicação mãe</i> e a <i>aplicação usuário</i>. Cada usuário vai interagir na 
                            seu dispositivo e a aplicação mãe vai exibir o resultado dessas interações.
                        </p>
                        <h3>Carinhas</h3>
                        <p>
                            Um exemplo muito muito simples para votação online. Cada usuário vai poder escolher a carinha que representa sua opnião e poderá ver, junto com a dos outros usuários, sua respectiva carinha. É encontrado na pasta "carinhas" do repositório.
                        </p>
                        <video width="48%" style="float:left; margin: 0 1%;" src="vid/carinhas.mp4" controls></video>
                        <video width="48%" style="float:right; margin: 0 1%;" src="vid/carinhas-2.mp4" controls></video>
                        <div style="clear:both;"></div>
                        <hr class="my-4" style="margin: 10px 0">
                        <h3 style="margin-bottom: 30px;">Jogo multiplayer</h3>
                        
                        <video width="80%" style="margin: 0 10%;" src="vid/jogo.mp4" controls></video>
                        
                    </div>
                </div>
            </article>
        </section>
        <footer class="bg-info text-white">
            Trabalho desenvolvido como parte do projeto de conclusão de curso 
            em Comunicação em Mídias Digitais na Universidade Federal da Paraíba. 
            <br/>Baseado na biblioteca <a href="https://github.com/ghedipunk/PHP-Websockets">PHP-Websockets</a>
        </footer>
    </main>
</body>
</html>